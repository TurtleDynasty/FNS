<!DOCTYPE html>
<html>
	<meta charset="utf-8">
	<style>
		text
		{
			font: 10px sans-serif;
			text-anchor: middle;
		}
		.axis path,
		.axis line
		{
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}

		.dot
		{
	  		stroke: #000;
		}

		.tooltip
		{
			position: absolute;
			width: 200px;
			height: 28px;
			pointer-events: none;
		}
	</style>

	<body>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script>
			// scroll-over circle enlargement
			var dotSize = 3.5;
			var dotPadding = 5;
			// setup margin
			var margin = {top: 50, right: 50, bottom: 50, left: 50};
			var width = 960 - margin.left - margin.right;
			var height = 1000 - margin.top - margin.bottom;
			var margin = {top: 20, right: 20, bottom: 30, left: 50};
			var legendWidth = 200;
			var width = 1080 - margin.left - margin.right - legendWidth;
			var height = 700 - margin.top - margin.bottom;
			var tickPadding = "10";
			var legendTileSize = 30;
			var legendSpacing = 30;
			var xUnit = "";
			var xAxisLabel = "File Space ID" + xUnit;
			var yUnit = "bytes";
			var yAxisLabel = "Actual Size (" + yUnit + ")";
			var labelFontSize = "20px"
			// setup x
			var xValue = function(d) { return d.X;}, // data -> value
	    		xScale = d3.scaleLinear().range([margin.left, width]), // value -> display
	    		xMap = function(d) { return xScale(xValue(d));}; // data -> display
	    		// xAxis = d3.svg.axis().scale(xScale).orient("bottom");

			// setup y
			var yValue = function(d) { return d["Y"];}, // data -> value
	    		yScale = d3.scaleLinear().range([height-margin.bottom, 0]), // value -> display
	    		yMap = function(d) { return yScale(yValue(d));}; // data -> display
	    		// yAxis = d3.svg.axis().scale(yScale).orient("left");

			// setup fill color
			var cValue = function(d) { return d.Type;},
	    		color = d3.scaleOrdinal(d3.schemeCategory10);

			// add the graph canvas to the body of the webpage
			var svg = d3.select("body").append("svg")
	    		.attr("width", width + margin.left + margin.right + legendWidth)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
	    		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			d3.selection.prototype.moveToBack = function()
			{
			    return this.each(function() {
			        var firstChild = this.parentNode.firstChild;
			        if (firstChild) {
			            this.parentNode.insertBefore(this, firstChild);
			        }
			    });
			};
			d3.selection.prototype.moveToFront = function()
			{
				return this.each(function(){
					this.parentNode.appendChild(this);
				});
			};
			function subject(d)
			{
				return { x: d3.event.x, y: d3.event.y };
			};
			var drag = d3.drag()
				.subject(subject)
				.on('start', function()
				{
					d3.select(".dragBar").remove();
					firstX = d3.event.x;
					firstY = d3.event.y;
					svg.append("rect")
						.classed("dragBar", true)
						.attr("x", firstX)
						.attr("y", firstY)
						.attr("width", 0)
						.attr("height", 0)
						.style("fill", "CornflowerBlue")
						.style("fill-opacity", .45)
						.call(drag)
						.on("click", function ()
						{
							d3.select(this).remove();
						});
					d3.select(".dragBar").moveToBack();
				})
				.on('drag', function() {
					d3.select(".dragBar").attr('width', function() {
						var x = d3.select(".dragBar").attr('x');
							return (d3.event.x-firstX);
					});
					d3.select(".dragBar").attr('height', function() {
						var y = d3.select(".dragBar").attr('y');
						return (d3.event.y-firstY);
					});
					var width = d3.select(".dragBar").attr("width");
					var height = d3.select(".dragBar").attr("height");
					if (width < 0 && height < 0)
					{
						d3.select(".dragBar").attr("transform", function()
						{
							return "translate(" + (width) + "," + (height) + ")";
						});
						d3.select(".dragBar").attr("width", Math.abs(width));
						d3.select(".dragBar").attr("height", Math.abs(height));
					}
					else if (width < 0)
					{
						d3.select(".dragBar").attr("transform", function()
						{
							return "translate(" + (width) + ",0)";
						});
						d3.select(".dragBar").attr("width", Math.abs(width));
					}
					else if (height < 0)
					{
						d3.select(".dragBar").attr("transform", function()
						{
							return "translate(0," + (height) + ")";
						});
						d3.select(".dragBar").attr("height", Math.abs(height));
					}




				})
				.on('end', function() {
					secondX = d3.event.x;
					secondY = d3.event.y;
					console.log(firstX);
					console.log(secondX);
					console.log(firstY);
					console.log(secondY);
				});
			svg.append("rect")
				.attr("x", 0)
				.attr("y", 0)
				.attr("width", width)
				.attr("height", height)
				.style("fill-opacity", 0)
				.call(drag);


			// add the tooltip area to the webpage
			var tooltip = d3.select("body").append("div")
				.attr("class", "tooltip")
				.style("opacity", 0);

			// load data
			d3.csv("cereal.csv", function(error, data)
			{
				if (error)
				{
					throw error;
				}

				// change string (from CSV) into number format
				data.forEach(function(d)
				{
					d.X = +d.X;
					d["Y"] = +d["Y"];
				// comment out this line before going live
				});

		 		// don't want dots overlapping axis, so add in buffer to data domain
				xScale.domain([d3.min(data, xValue)-1, d3.max(data, xValue)+1]);
				yScale.domain([d3.min(data, yValue)-1, d3.max(data, yValue)+1]);

				createXAxis();
				createYAxis();
				drawDots(data);
				drawLegend();
			});

			function createXAxis()
			{
				// x-axis
				svg.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + (height - margin.bottom) + ")")
					.call(d3.axisBottom(xScale))

				// add X Axis label
				svg.append("text")
						.attr("class", "label")
						.attr("transform", "rotate(0)")
						.attr("y", height )
						.attr("x", width/2)
						.attr("dy", "1em")
						.style("font-size", labelFontSize)
						.style("text-anchor", "middle")
						.text(xAxisLabel);
			}
			function createYAxis()
			{
				// y-axis
				svg.append("g")
					.call(d3.axisLeft(yScale).tickPadding(["10"]))
					.attr("class", "y axis")
					.attr("transform", "translate(" + margin.left + ",0)")

				// add Y Axis label
				svg.append("text")
						.attr("class", "label")
						.attr("transform", "translate(" + (-5) + "," + ((height-margin.bottom)/2) + ") rotate(-90)")
						.attr("y", 0)
						.attr("x", 0)
						.attr("dy", "1em")
						.style("font-size", labelFontSize)
						.style("text-anchor", "middle")
						.text(yAxisLabel);
			}
			function drawDots(data)
			{
				// draw dots
				svg.selectAll(".dot")
					.data(data)
					.enter().append("circle")
					.attr("class", function(d)
					{
						return d.Type.replace(/\s/g, '');
					})
					.attr("r", dotSize)
					.attr("cx", function(d)
					{
						return xScale(d.X);
					})
					.attr("cy", function(d)
					{
						return yScale(d.Y);
					})
					.style("fill", function(d)
					{
						return color(cValue(d));
					})
					.style("fill-opacity", 1)
					.on("mouseover", function(d)
					{
						d3.select(this).attr("r", dotSize + dotPadding);
						var test = d3.select(this)["_groups"][0][0]["style"]["fill-opacity"];
						if (test != 0)
						{
							tooltip.transition()
								.duration(200)
								.style("opacity", .9);
							tooltip.html(d["Name"] + "<br/> (" + xValue(d) + ", " + yValue(d) + ")")
								.style("left", (d3.event.pageX + dotSize + dotPadding + 10) + "px")
								.style("top", (d3.event.pageY - 28) + "px");
						}
					})
					.on("mouseout", function(d)
					{
						d3.select(this).attr("r", dotSize);
						tooltip.transition()
							.duration(500)
							.style("opacity", 0);
					})
					.call(drag);
			}
			function drawLegend()
			{
				// draw legend
				var legend = svg.selectAll(".legend")
					.data(color.domain())
					.enter().append("g")
					.attr("class", "legend")
					.attr("transform", function(d, i)
					{
						return "translate(" + legendWidth + "," + i * legendSpacing + ")";
					});
				var i = 0;
				// draw legend colored rectangles
				legend.append("rect")
					.attr("class", color)
					.attr("fill-opacity", 1)
					.attr("x", width - legendTileSize)
					.attr("y", function ()
					{
						i += 1;
						return i * legendTileSize;
					})
					.attr("rx", 5)
					.attr("ry", 5)
					.attr("width", legendTileSize)
					.attr("height", legendTileSize)
					.style("stroke", color)
					.style("stroke-width", 2)
					.style("fill", color)
					.on("click", function (d)
					{
						var dotType = "." + d.replace(/\s/g, '');
						var dotList = d3.selectAll(dotType)
						.style("fill-opacity", function (d)
						{
							var opacity = d3.selectAll(this)["_groups"][0]["style"]["fill-opacity"];
							if (opacity == 1)
							{
								d3.select(this).attr("r", 0);
								return 0;
							}
							else
							{
								d3.select(this).attr("r", dotSize);
								return 1;
							}
						});
						var opacity = d3.select(this).attr("fill-opacity");
						if (opacity == 1)
						{
							opacity = d3.select(this).attr("fill-opacity", 0);
						}
						else
						{
							opacity = d3.select(this).attr("fill-opacity", 1);
						}
						//.style("opacity", 0);
					});
				var i = 0;
				// draw legend text
				legend.append("text")
					.attr("x", width - legendTileSize - 7)
					.attr("y", function () {
						i += 1;
						return i * legendTileSize;
					})
					.attr("dy", legendTileSize/2 + 1)
					.style("text-anchor", "end")
					.text(function(d) {
						return d;
					})
			}
		</script>
	</body>
</html>
