<!DOCTYPE html>
<meta charset="utf-8">
<style>

text {
	font: 10px sans-serif;
	text-anchor: middle;
}

</style>
<svg width="700" height="800"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
var circleColors = ["darkblue",
					"blue",
					"seagreen",
					"Turquoise",
					"SpringGreen",
					"greenyellow",
					"yellow",
					"orange",
					"orangered",
					"red"];
var svg = d3.select("svg");
var width = +svg.attr("width");
var heatMapWidth = width - 100;
var height = +svg.attr("height");
var circlePadding = 5;
var circleRadius = 25;
var x = 0;
var xIndex = 0;
var y = 0;
var yIndex = 0;
var legendTileSize = 25;
var infoTileSize = 125;
var infoTilePadding = 5;
svg.append("rect")
.attr("x", 0)
.attr("width", heatMapWidth)
.attr("y", 0)
.attr("height", heatMapWidth)
.style("fill", "black")
.style("fill-opacity", .25)
var maxColor = -Infinity;
var minColor = Infinity;
d3.csv("heatmap.csv", function(d) {
	d.value = +d.value;
	if (d.value > 1)
	{
		if (d.value < minColor)
		{
			minColor = d.value;
		}
		if (d.value > maxColor)
		{
			maxColor = d.value;
		}
		return d;
	}
}, function(error, classes)
	{
		if (error)
		{
			throw error;
	 	}
		circleRadius = heatMapWidth / Math.sqrt(classes.length) - circlePadding;
		console.log(classes.length);
		console.log(circleRadius);
		for(i = 0; i < classes.length; i++)
		{
			var number = 10;
			svg.append("rect")
			.classed(grabClassColor(classes[i]["value"]), true)
			.attr("color", grabClassColor(classes[i]["value"]))
			.classed("circleBubble", true)
			.attr("value", classes[i]["value"])
			.attr("id", classes[i]["id"])
			.attr("x", x)
			.attr("y", y)
			.attr("height", circleRadius)
			.attr("width", circleRadius)
			.attr("fill-opacity", 1)
			.attr("stroke-opacity", 0)
			.attr("stroke-width", 2)
			.style("stroke", "black")
			.style("fill", function() { return grabColor(classes[i]["value"], circleColors); })
			.on("mouseover", function() {
				mouseEnterSquare(this);
			})
			.on("mouseout", function() {
				mouseExitSquare(this);
			})
			.on("click", function(d)
			{
				moveInfoSquares(infoTileSize + infoTilePadding);
				drawInfoSquare(this, d3.select(this).attr("color"));
			});

			x += circleRadius + circlePadding;
			xIndex += 1;
			if (x > heatMapWidth)
			{
				x = 0;
				y += circleRadius + circlePadding;
				xIndex = 0;
				yIndex += 1;
			}
		}
		function moveInfoSquares(offset)
		{
			d3.selectAll(".infoNode").attr('x', function ()
			{
				var x = parseFloat(d3.select(this).attr('x'));
				x += offset;
				if (x > heatMapWidth)
				{
					d3.select(this).remove();
				}
				return x;
			})
		}
		function drawInfoSquare(d, color)
		{
			var value = d3.select(d).attr("value");
			var id = d3.select(d).attr("id");
			var id = id.split(".");
			var id = id[id.length-1];

			svg.append("rect")
			.classed("infoNode", true)
			.attr("x", 0)
			.attr("y", heatMapWidth + 25)
			.attr("width", infoTileSize)
			.attr("height", infoTileSize)
			.style("fill", color)

			svg.append("rect")
			.classed("infoNode", true)
			.attr("x", 0 + infoTilePadding)
			.attr("y", heatMapWidth + 25 + infoTilePadding)
			.attr("width", infoTileSize-2*infoTilePadding)
			.attr("height", infoTileSize-2*infoTilePadding)
			.style("fill", "white")

			svg.append("text")
			.classed("infoNode", true)
			.attr("x", 0 + (infoTileSize-2*infoTilePadding)/2)
			.attr("y", heatMapWidth + 25 + (infoTileSize-2*infoTilePadding)/2)
			.attr("dy", "-1.5em")
			.style("fill", "black")
			.text(id);

			svg.append("text")
			.classed("infoNode", true)
			.attr("x", 0 + (infoTileSize-2*infoTilePadding)/2)
			.attr("y", heatMapWidth + 25 + (infoTileSize-2*infoTilePadding)/2)
			.attr("dy", "1.5em")
			.style("fill", "black")
			.text(value);

		}
		drawLegend();
		function drawLegend()
		{
			var increment = (heatMapWidth / circleColors.length)+1;
			for (i = 0; i < circleColors.length; i++)
			{
				svg.append("rect")
				.classed("legend", true)
				.classed(circleColors[i], true)
				.attr("color", circleColors[i])
				.attr("x", heatMapWidth + 10)
				.attr("y", circleRadius + i * increment)
				.attr("fill-opacity", 1)
				.attr("stroke", circleColors[i])
				.attr("rx", 5)
				.attr("ry", 5)
				.attr("height", legendTileSize)
				.attr("width", legendTileSize)
				.style("fill", circleColors[i])
				.on("mouseover", function() {
					var opacity = d3.select(this).attr("fill-opacity");
					toggleBoarder(d3.select(this).attr("color"));

				})
				.on("mouseout", function() {
					var opacity = d3.select(this).attr("fill-opacity");
					toggleBoarder(d3.select(this).attr("color"));
				})
				.on("click", function(d)
				{
					filterColor(d3.select(this).attr("color"));
				});
			}

		}
		function toggleBoarder(color)
		{
			var color2filter = "." + color;
			d3.selectAll(color2filter).attr("stroke-opacity", function()
			{
				var opacity = d3.select(this).attr("stroke-opacity");
				if (opacity == 0)
				{
					return 1;
				}
				else if (opacity == 1)
				{
					return 0;
				}
			})
		}
		function filterColor(color)
		{
			var color2filter = "." + color;
			colorSqaureList = d3.selectAll(color2filter).attr("fill-opacity", function()
			{
				var opacity = d3.select(this).attr("fill-opacity");
				if (opacity == 0)
				{
					return 1;
				}
				else if (opacity == 1)
				{
					return 0;
				}
			});
			for (i = 0; i < colorSqaureList.length; i++)
			{
				var opacity = colorSqaureList[i]["fill-opacity"];
				console.log(opacity);
			}
		}
		function grabClassColor(number)
		{
			var divideColor = d3.scaleLinear().domain([minColor, maxColor+1]).range([0, 1]);
			var index = Math.floor(divideColor(number) * 10);
			return circleColors[index];
		}
		function grabColor(number, colors)
		{
			var divideColor = d3.scaleLinear().domain([minColor, maxColor]).range([0, 1]);
			var pickColor = d3.scaleLinear().domain([0, .1, .2, .3, .4, .5, .6, .7, .8, .9]).range(colors);
			var color = divideColor(number);
			return pickColor(color);
		}
		function mouseEnterSquare(object)
		{
			d3.select(object).attr('width', circleRadius + circlePadding);
			d3.select(object).attr('height', circleRadius + circlePadding);
			d3.select(object).attr("stroke-opacity", 1);
			d3.select(object).attr('x', function ()
			{
				var x = parseFloat(d3.select(object).attr('x'));
				return (x - circlePadding/2);
			})
			.attr('y', function ()
			{
				var y = parseFloat(d3.select(object).attr('y'));
				return (y - circlePadding/2);
			})
		}
		function mouseExitSquare(object)
		{
			d3.select(object).attr('width', circleRadius);
			d3.select(object).attr('height', circleRadius);
			d3.select(object).attr("stroke-opacity", 0);
			d3.select(object).attr('x', function ()
			{
				var x = parseFloat(d3.select(object).attr('x'));
				return (x + circlePadding/2);
			})
			.attr('y', function ()
			{
				var y = parseFloat(d3.select(object).attr('y'));
				return (y + circlePadding/2);
			})
		}
	});


</script>
