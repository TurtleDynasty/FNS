<!DOCTYPE html>
<meta charset="utf-8">
<style>

text {
	font: 10px sans-serif;
	text-anchor: middle;
}

</style>
<svg width="1000" height="1200"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
var circleInView = {"darkblue": false,
					"blue": false,
					"seagreen": false,
					"Turquoise": false,
					"SpringGreen": false,
					"greenyellow": false,
					"yellow": false,
					"orange": false,
					"orangered":false,
					"red": false};

var circleColors = ["darkblue",
					"blue",
					"seagreen",
					"Turquoise",
					"SpringGreen",
					"greenyellow",
					"yellow",
					"orange",
					"orangered",
					"red"];

var distro = ["0 - 10",
			"10 - 20",
			"20 - 30",
			"30 - 40",
			"40 - 50",
			"50 - 60",
			"60 - 70",
			"70 - 80",
			"80 - 90",
			"90 - 100"];

var svg = d3.select("svg");
var width = +svg.attr("width");
var height = +svg.attr("height");
var bubblePadding = 3;
var format = d3.format(",d");
var legendTileSize = 50;
var deletionCircleSize = 10;
var bubbleGraphYOffset = 0;
var infoBubblePadding = 15;
var infoBubbleFontSize = "10px";
var legendXTextPadding = -5; // Negative shifts text to the left.
var r = 80;
var offset = 80;
var x = r + 1;
var y = height * .9;
var deletionCirclePadding = 25;
function moveCircle(offset, xCord)
{
	d3.selectAll(".bubbleCircle")
	.transition()
  	.duration(50)
	.attr("transform", function(d) {
		var x = d3.select(this)["_groups"][0][0]["transform"]["baseVal"][0]["matrix"]["e"];
		var y = d3.select(this)["_groups"][0][0]["transform"]["baseVal"][0]["matrix"]["f"];
		if (x > xCord)
		{
			var y = d3.select(this)["_groups"][0][0]["transform"]["baseVal"][0]["matrix"]["f"];
			return "translate(" + (x + 2*offset) + "," + y + ")";
		}
		else if (x < xCord)
		{
			return "translate(" + x + "," + y + ")";
		}
		else
		{
			return "translate(-200,9001)";
		}

	});
}
function moveText(offset, xCord)
{
	d3.selectAll(".bubbleText")
	.transition()
	.duration(50)
	.attr("y", function (d) {
		var x = d3.select(this)["_groups"][0][0]["x"]["baseVal"][0]["value"];
		var y = d3.select(this)["_groups"][0][0]["y"]["baseVal"][0]["value"];
		if (x != xCord)
		{
			return y;
		}
		else
		{
			return 9001;
		}
	})
	.attr("x", function (d) {
		var x = d3.select(this)["_groups"][0][0]["x"]["baseVal"][0]["value"];
		if (x > xCord)
		{
			x = x + 2*offset;
			return x;
		}
		else if (x < xCord)
		{
			return x;
		}
		else
		{
			return -200;
		}
	});
}
function addCircle(d, className)
{
	addLargeCircle(d, className);
	addTextBackground(d, className)
	addTopText(d, className);
	addBottomText(d, className);
	addDeletionCircle(d, className)
}
function highlightCircle(className)
{
	var opacity = d3.select(className)["_groups"][0][0]["style"]["opacity"];
	var to = [1,0];
	var from = [0,1];
	if (to[opacity] != null)
	{
		d3.select(className)
		.style("opacity", to[opacity])
		.transition()
		.duration(200)
		.style("opacity", from[opacity])
		.transition()
		.duration(300);
	}
}
function addLargeCircle(d, className)
{
	svg.append("circle")
		.attr("r", r)
		.style("fill", grabColor(d.value, circleColors))
		.style("stroke", "black")
		.style("stroke-width", 2)
		.attr("transform", function(d) {
			return "translate(" + r + "," + (y - bubbleGraphYOffset) + ")";
		})
		.attr("class", "bubbleCircle")
		.on("click", function(d) {
			highlightCircle(className);
		});
}
function addDeletionCircle(d, className)
{
	svg.append("circle")
		.attr("r", deletionCircleSize)
		.style("fill", "red")
		.style("stroke", "black")
		.style("stroke-width", 2)
		.attr("transform", function(d) {
			return "translate(" + r + "," + (y - bubbleGraphYOffset + r + deletionCirclePadding) + ")";
		})
		.attr("class", "bubbleCircle")
		.on("click", function(d) {
					var x = d3.select(this)["_groups"][0][0]["transform"]["baseVal"][0]["matrix"]["e"];
					moveCircle(-offset, x);
					moveText(-offset, x);
				});
	var whiteWidth = 15;
	var whiteHeight = 7;
	svg.append("rect")
		.attr("width", whiteWidth)
		.attr("height", whiteHeight)
		.style("fill", "white")
		.style("stroke", "black")
		.style("stroke-width", 1)
		.attr("transform", function(d) {
			return "translate(" + (r - whiteWidth/2) + "," + (y + r - whiteHeight/2 + deletionCirclePadding) + ")";
		})
		.attr("class", "bubbleCircle")
		.on("click", function(d) {
					var x = d3.select(this)["_groups"][0][0]["transform"]["baseVal"][0]["matrix"]["e"];
					moveCircle(-offset, x);
					moveText(-offset, x);
				});
}
function addTextBackground(d, className)
{
	svg.append("circle")
		.attr("r", r - 10)
		.style("fill", "white")
		.style("stroke", "black")
		.style("stroke-width", 2)
		.attr("transform", function(d) {
			return "translate(" + r + "," + (y - bubbleGraphYOffset) + ")";
		})
		.attr("class", "bubbleCircle")
		.on("click", function(d) {
			highlightCircle(className);
		});
}
function addTopText(d, className)
{
	svg.append("text")
		.attr("x", x)
		.attr("y", y - bubbleGraphYOffset)
		.attr("dy", - infoBubblePadding)
		.attr("width", legendTileSize)
		.attr("height", legendTileSize)
		.style("text-anchor", "middle")
		.style("font-weight", "bolder")
		.style("font-size", infoBubbleFontSize)
		.text(d.class)
		.style("fill", "black")
		.attr("class", "bubbleText")
		.on("click", function(d) {
			highlightCircle(className);
		});
}
function addBottomText(d, className)
{
	svg.append("text")
		.attr("x", x)
		.attr("y", y - bubbleGraphYOffset)
		.attr("dy", infoBubblePadding)
		.attr("width", legendTileSize)
		.attr("height", legendTileSize)
		.style("text-anchor", "middle")
		.style("font-size", infoBubbleFontSize)
		.text(d.value)
		.style("fill", "black")
		.attr("class", "bubbleText")
		.on("click", function(d) {
			highlightCircle(className);
		});
}
function grabClassColor(number)
{
	var divideColor = d3.scaleLinear().domain([minColor, maxColor+1]).range([0, 1]);
	var index = Math.floor(divideColor(number) * 10);
	return circleColors[index];
}
function grabColor(number, colors)
{
	var divideColor = d3.scaleLinear().domain([minColor, maxColor]).range([0, 1]);
	var pickColor = d3.scaleLinear().domain([0, .1, .2, .3, .4, .5, .6, .7, .8, .9]).range(colors);
	var color = divideColor(number);
	return pickColor(color);
}
var legendWidth = 100;
console.log(height);
var pack = d3.pack()
.size([width - legendWidth, height/1.175])
.padding(bubblePadding);
var maxColor = 0;
var minColor = 9999999999999;
d3.csv("heatmap.csv", function(d) {
	d.value = +d.value;
	if (d.value > 1)
	{
		if (d.value < minColor)
		{
			minColor = d.value;
		}
		if (d.value > maxColor)
		{
			maxColor = d.value;
		}
		return d;
	}
}, function(error, classes)
	{
		if (error)
		{
			throw error;
	 	}

		var root = d3.hierarchy({children: classes})
		.sum(function(d) { return d.value; })
		.each(function(d) {
			if (id = d.data.id) {
				var id, i = id.lastIndexOf(".");
				d.id = id;
				d.package = id.slice(0, i);
				d.class = id.slice(i + 1);
			}
		});

		addDataCircles(root);
		createColorLegend();

	});
	function applyBoader(data, className, strokeWidth, offset)
	{
		d3.select(className).attr("r", data.r + offset)
		.style("stroke", "black")
		.style("stroke-width", strokeWidth);
	}
	function addDataCircles(root)
	{
		var node = svg.selectAll(".node")
		.data(pack(root).leaves())
		.enter().append("g")
		.attr("class", "node")
		.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

		node.append("circle")
		.attr("id", function(d) { return d.id; })
		.attr("r", function(d) { return d.r; })
		.attr("transform", function (d)
		{
			return "translate(0," + bubbleGraphYOffset + ")";
		})
		.attr("class", function(d) { return grabClassColor(d.value); })
		.style("fill", function(d) { return grabColor(d.value, circleColors); })
		.style("opacity", 1)
		.on("click", function(d) {
			var opacity = d3.select(this)["_groups"][0][0]["style"]["opacity"];
			if (opacity == 1)
			{
				moveCircle(offset, 0);
				moveText(offset, 0);
				addCircle(d, this);
			}
		})
		.on("mouseover", function(d) {
			applyBoader(d, this, 2, bubblePadding);
			var legendTile = "." + grabClassColor(d.value) + "L";
			d3.select(legendTile)
			.style("stroke-width", function (d)
			{
				var opacity = d3.select(legendTile)["_groups"][0][0]["style"]["fill-opacity"];
				if (opacity == 1)
				{
					return 5;
				}
				else
				{
					return 3;
				}
			});
		})
		.on("mouseout", function(d) {
			applyBoader(d, this, 0, 0);
			var className = "." + grabClassColor(d.value) + "L";
			d3.select(className)
			.style("stroke-width", 3);
		});
	}
	function createColorLegend()
	{
		var legendPadding = 20;
		for(i = 0; i < circleColors.length; i++)
		{
			var offset = 20;
			// Colored rectangles for legend
			legendTile = svg.append("rect")
			.attr("class", circleColors[i] + "L")
			.attr("rx", 10)
			.attr("ry", 10)
			.attr("x", width - legendTileSize-30)
			.attr("y", legendTileSize * i + legendPadding * i)
			.attr("width", legendTileSize)
			.attr("height", legendTileSize)
			.style("fill", circleColors[i])
			.style("stroke", circleColors[i])
			.style("stroke-width", 3)
			.style("fill-opacity", 1)
			.on("click", function(d) {
				var fillColor = d3.select(this)["_groups"][0][0]["style"]["fill"];
				var strokeColor = d3.select(this)["_groups"][0][0]["style"]["stroke"];
				toggleVisibility(d, "." + fillColor);
			})
			// Text labels for the colored rectangles.
			svg.append("text")
			.attr("x", width - legendTileSize + legendXTextPadding-30)
			.attr("y", (legendTileSize * i) + legendTileSize/2 + legendPadding*i)
			.attr("dy", ".5em")
			.attr("width", legendTileSize)
			.attr("height", legendTileSize)
			.style("text-anchor", "end")
			.text(distro[i] + "%");
		}
	}
	function toggleVisibility(data, color)
	{
		// Toggles whether a color is visible or not. aka makes it invisible
		subColor = color.substring(1);
		circleInView[subColor] = !circleInView[subColor];
		d3.selectAll(color)
		.style("opacity", function(d) {
			if (circleInView[subColor])
			{
				return 0;
			}
			else
			{
				return 1;
			}
		})
		.transition()
		.duration(0);
		var legendTile = color + "L";
		d3.select(legendTile)
		.style("fill-opacity", function(d) {
			if (circleInView[subColor])
			{
				return 0;
			}
			else
			{
				return 1;
			}
		})
	}

</script>
