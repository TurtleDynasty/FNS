<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

.bar { fill: steelblue; }

</style>
<body>

	<!-- load the d3.js library -->
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script>
	var xUnit = "";
	var xAxisLabel = "File Space ID" + xUnit;
	var yUnit = "bytes";
	var yAxisLabel = "Actual Size (" + yUnit + ")";
	// set the dimensions and margins of the graph
	var margin = {top: 50, right: 50, bottom: 50, left: 50},
	var width = 960 - margin.left - margin.right;
	var height = 500 - margin.top - margin.bottom;

	// set the ranges
	var x = d3.scaleBand()
		.range([0, width])
		.padding(0.1);
	var y = d3.scaleLinear()
		.range([height, 0]);

	// append the svg object to the body of the page
	// append a 'group' element to 'svg'
	// moves the 'group' element to the top left margin
	var svg = d3.select("body").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform",
		"translate(" + margin.left + "," + margin.top + ")");

	var flipCount = 0;
	var toggleSwap = true;
	var buttonColors = ["red", "blue"];
	var flipButton = svg.append("rect")
		.attr("class", "flipButton")
		.attr("x", width)
		.attr("y", 20)
		.attr("width", 20)
		.attr("height", 20)
		.on("click", function (d)
		{

			d3.select(this).style("fill", function (d) {
				flipCount += 1;
				return buttonColors[flipCount%2];
			});
			if (flipCount%2 == 0)
			{
				swapBars("bar2", "bar3");
			}
			else
			{
				swapBars("bar3", "bar2");
			}
			toggleSwap = !toggleSwap;
		})
		.style("fill", "red");

	// get the data
	var stackOrder;
	var stackNum = 1; // default is one, will be changed if addition columns are present
	d3.csv("data.csv", function(error, data) {
		if (error)
		{
			throw error;
		}

		// format the data
		data.forEach(function(d)
		{
			d.value1 = +d.value1;
			if (!isNaN(d.value2))
			{
				stackNum = 2;
				d.value2 = +d.value2;
			}
			if (!isNaN(d.value3))
			{
				stackNum = 3;
				d.value3 = +d.value3;
			}
			if (!isNaN(d.value4))
			{
				stackNum = 4;
				d.value4 = +d.value4;
			}
		});
		function maxNumber(data)
		{
			switch (stackNum)
			{
				case 1:
					return data.value1;
					break;
				case 2:
					return data.value2;
					break;
				case 3:
					return data.value3;
					break;
				case 4:
					return data.value4;
					break;
			}
		}
		// Scale the range of the data in the domains
		x.domain(data.map(function(d) { return d.name; }));
		y.domain([0, d3.max(data, function(d) { return maxNumber(d); })]);

		// append the rectangles for the bar chart
		svg.append("g")
		.attr("class", function (d)
		{
			for(i = 0; i < data.length; i++)
			{
				addBar(data[i].name, x(data[i].name), y(data[i].value4), y(data[i].value3)-y(data[i].value4), "orange", "bar4");
				addBar(data[i].name, x(data[i].name), y(data[i].value3), y(data[i].value2)-y(data[i].value3), "cyan", "bar3");
				addBar(data[i].name, x(data[i].name), y(data[i].value2), y(data[i].value1)-y(data[i].value2), "blue", "bar2");
				addBar(data[i].name, x(data[i].name), y(data[i].value1), height - y(data[i].value1), "red", "bar1");
			}
			return "garbage";

		})

		createXAxis();
		createyAxis();


	});
	// svg.selectAll(".class1, class2, #id2")
	function swapBars(bar1, bar2, toggle)
	{
		console.log(bar1 + " -> " + bar2);
		var barList1 = d3.selectAll("." + bar1)["_groups"][0];
		var barList2 = d3.selectAll("." + bar2)["_groups"][0];
		console.log(barList1);
		console.log(barList2);
		for(i = 0; i < barList1.length; i++)
		{
			console.log("here");
			var bar1Y = barList1[i]["y"]["baseVal"]["value"];
			var bar2Y = barList2[i]["y"]["baseVal"]["value"];
			console.log("Y's: " + bar1Y + ", " + bar2Y);
			var bar1H = barList1[i]["height"]["baseVal"]["value"];
			var bar2H = barList2[i]["height"]["baseVal"]["value"];
			console.log("H's: " + bar1H + ", " + bar2H);
			barList1[i]["y"]["baseVal"]["value"] = bar1Y + bar2H;
			barList2[i]["y"]["baseVal"]["value"] = bar2Y - bar1H;

		}
		console.log("/ " + bar1 + " -> " + bar2);

	}

	function createXAxis()
	{
		// add the X Axis
		svg.append("g")
			.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(x));

		// add X Axis label
		svg.append("text")
			.attr("class", "label")
			.attr("transform", "rotate(0)")
			.attr("y", height + 20)
			.attr("x", width/2)
			.attr("dy", "1em")
			.style("text-anchor", "middle")
			.text(xAxisLabel);
	}
	function createyAxis()
	{
		// add the Y Axis
		svg.append("g")
			.call(d3.axisLeft(y));

		// add Y Axis label
		svg.append("text")
			.attr("class", "label")
			.attr("transform", "rotate(-90)")
			.attr("y", 0 - margin.left)
			.attr("x", 0 - (height / 2) - 5)
			.attr("dy", "1em")
			.style("text-anchor", "middle")
			.text(yAxisLabel);
	}
	function addBar(name, xCord, yCord, barHeight, color, className)
	{
		svg.append("rect")
			.classed('bars', true)
			.classed(className, true)
			.classed(name, true)
			.attr("x", function(d) {
				return xCord;
			})
			.attr("width", x.bandwidth())
			.attr("y", function(d) {
				return yCord;
			})
			.attr("height", function(d) {
				return barHeight;
			})
			.style("fill", color);
	}


	</script>
</body>
